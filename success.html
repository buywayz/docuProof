<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">

<title>Payment complete — proof saved | docuProof</title>
<meta name="description" content="Your proof has been queued for anchoring on Bitcoin.">

<link rel="icon" href="/docuproof-logo.png">
<meta name="theme-color" content="#0b0f14">
<style>
  :root{
    --bg:#0b0f14;--ink:#eaeaea;--muted:#a7b0ba;--accent:#22C55E;
    --card:#151b22;--card-soft:#10151b;--border:#1e2630;--link:#9cc1ff;
    --danger:#ffb4b4;--danger-bg:#1a0b0b;
    --neutral-bg:#151821;--neutral-border:#303749;--neutral-text:#cbd3e1;
    --warn-bg:#231c12;--warn-border:#5f461f;--warn-text:#f4d28a;
    --ok-bg:#0d1912;--ok-border:#1e5131;--ok-text:#9af3b4;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    background:var(--bg);
    color:var(--ink);
    font:16px/1.6 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
  }
  a{color:var(--link)}
  header,main,footer{max-width:1100px;margin:auto;padding:16px 20px}
  .header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    border-bottom:1px solid var(--border);
  }
  .brand{display:flex;gap:10px;align-items:center;text-decoration:none;color:var(--ink)}
  .brand img{height:32px}
  h1{font-size:32px;margin:18px 0 8px}
  .subhead{color:var(--muted);margin-bottom:24px}

  .layout{
    display:flex;
    flex-wrap:wrap;
    gap:20px;
  }
  .main-card{
    flex:2 1 520px;
    background:var(--card);
    border:1px solid var(--border);
    border-radius:16px;
    padding:20px 20px 24px;
  }
  .side-card{
    flex:1 1 260px;
    background:var(--card-soft);
    border:1px solid var(--border);
    border-radius:16px;
    padding:18px 18px 22px;
  }

  .label{font-size:13px;color:var(--muted);margin-bottom:2px}
  .value{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:14px}

  .row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .status-dot{
    width:8px;height:8px;border-radius:999px;
    display:inline-block;
  }
  .status-dot.neutral{background:#f4d28a;}
  .status-dot.warn{background:#f4d28a;}
  .status-dot.err{background:#ff6b6b;}
  .status-dot.ok{background:#22C55E;}

  .status-pill{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:6px 10px;
    border-radius:999px;
    font-size:13px;
  }
  .status-pill.neutral{
    background:var(--neutral-bg);
    border:1px solid var(--neutral-border);
    color:var(--neutral-text);
  }
  .status-pill.warn{
    background:var(--warn-bg);
    border:1px solid var(--warn-border);
    color:var(--warn-text);
  }
  .status-pill.ok{
    background:var(--ok-bg);
    border:1px solid var(--ok-border);
    color:var(--ok-text);
  }

  .field-row{margin-top:10px;margin-bottom:6px}
  .actions{margin-top:18px;display:flex;flex-wrap:wrap;gap:10px}
  button{
    border-radius:999px;
    border:1px solid var(--border);
    background:#0f141a;
    color:var(--ink);
    padding:10px 18px;
    font-size:14px;
    cursor:pointer;
    font-weight:600;
  }
  button.primary{
    background:var(--accent);
    color:#071109;
    border:none;
  }
  button:disabled{
    opacity:0.4;
    cursor:default;
  }
  .helper-box{
    margin-top:18px;
    border-radius:12px;
    border:1px solid #164e2f;
    background:#08140d;
    padding:14px 14px 16px;
    font-size:13px;
    color:var(--neutral-text);
  }
  .helper-box strong{color:#c0f2ce}

  .what-next{
    margin-top:24px;
    background:var(--card);
    border:1px solid var(--border);
    border-radius:16px;
    padding:18px 20px 22px;
  }
  .what-next h2{margin:0 0 8px;font-size:18px}
  .what-next ul{
    margin:8px 0 0;
    padding-left:18px;
    color:var(--muted);
    font-size:14px;
  }

  footer{
    color:var(--muted);
    text-align:center;
    border-top:1px solid var(--border);
    margin-top:28px;
    padding:24px 20px;
  }

  @media (max-width:900px){
    h1{font-size:26px}
  }
</style>
</head>
<body>
<header class="header">
  <a class="brand" href="/" aria-label="docuProof home">
    <img src="/docuproof-logo.png" alt="docuProof">
    <strong>docuProof</strong>
  </a>
  <nav>
    <a href="/start.html">Start</a> · <a href="/app">App</a> · <a href="/verify">Verify</a>
  </nav>
</header>

<main>
  <h1>Payment complete — proof saved</h1>
  <div class="subhead">
    Below are your next steps and live status. Keep your original file with the downloaded proof bundle.
  </div>

  <section class="layout">
    <article class="main-card">
      <!-- Proof ID -->
      <div class="field-row">
        <div class="label">Proof ID</div>
        <div class="row">
          <div id="proofId" class="value">—</div>
          <a id="statusLink" href="#" style="font-size:13px;">status</a>
          <a id="viewLiveLink" href="#" style="font-size:13px;">View live</a>
        </div>
      </div>

      <!-- Status -->
      <div class="field-row">
        <div class="label">Status</div>
        <div id="statusPill" class="status-pill neutral">
          <span class="status-dot neutral"></span>
          <span id="statusText">Queued for anchoring</span>
        </div>
      </div>

      <!-- Txid -->
      <div class="field-row">
        <div class="label">Bitcoin txid</div>
        <div id="txidValue" class="value">—</div>
      </div>

      <!-- Actions -->
      <div class="actions">
        <button id="openVerify" class="primary">Open Verify Page</button>
        <button id="dlOts" disabled>Download OTS Receipt</button>
        <button id="dlPdf">Download PDF Certificate</button>
      </div>

      <div class="helper-box" id="helperBox">
        <strong>What this means:</strong>
        <div id="helperText">
          Your receipt is created and your proof has been queued for batching and anchoring to Bitcoin.
          You can always verify later at the <strong>Verify</strong> link using your Proof ID.
        </div>
      </div>
    </article>

    <aside class="side-card">
      <h3 style="margin:0 0 8px;font-size:18px;">What happens next?</h3>
      <ul style="margin:6px 0 0 0;padding-left:18px;font-size:14px;color:var(--muted);">
        <li>Your receipt is already created and downloadable above (once ready).</li>
        <li>We batch and anchor proofs to Bitcoin. Once mined, a txid appears with confirmations.</li>
        <li>You can always verify later via <strong>Verify</strong> using your Proof ID.</li>
      </ul>
    </aside>
  </section>

  <section class="what-next">
    <h2>Keep your proof bundle together</h2>
    <ul>
      <li>Save your original file (for example <code>document.pdf</code>).</li>
      <li>Save the OpenTimestamps receipt (for example <code>document.pdf.ots</code>).</li>
      <li>Optionally save this PDF certificate for a human-readable summary and QR.</li>
    </ul>
  </section>
</main>

<footer>
  © <span id="year"></span> docuProof.io — Proof of Existence on the Bitcoin Blockchain.
</footer>

<script>
(function () {
  function $(id){ return document.getElementById(id); }

  document.getElementById("year").textContent = new Date().getFullYear();

  // --- Pull proofId from URL (session_id or id) ---
  const params = new URLSearchParams(location.search);
  const proofId = (params.get("session_id") || params.get("id") || "").trim();

  const proofIdEl   = $("proofId");
  const statusPill  = $("statusPill");
  const statusText  = $("statusText");
  const txidValue   = $("txidValue");
  const helperText  = $("helperText");
  const openVerify  = $("openVerify");
  const dlOts       = $("dlOts");
  const dlPdf       = $("dlPdf");
  const statusLink  = $("statusLink");
  const viewLive    = $("viewLiveLink");

  if (!proofId) {
    proofIdEl.textContent = "Missing session_id";
    openVerify.disabled = true;
    dlPdf.disabled = true;
    dlOts.disabled = true;
    return;
  }

  proofIdEl.textContent = proofId;

  const verifyUrl = "/verify?id=" + encodeURIComponent(proofId);
  statusLink.href = verifyUrl;
  viewLive.href   = verifyUrl;
  openVerify.onclick = function () {
    window.location.href = verifyUrl;
  };

      dlPdf.onclick = function () {
    window.location.href =
      "/.netlify/functions/proof_pdf_meta?id=" + encodeURIComponent(proofId);
  };

  function setStatus(kind, label, helper) {
    statusPill.className = "status-pill " + kind;
    const dot = statusPill.querySelector(".status-dot") || document.createElement("span");
    dot.className = "status-dot " + kind;
    if (!dot.parentNode) statusPill.insertBefore(dot, statusPill.firstChild);
    statusText.textContent = label;
    if (helper) helperText.textContent = helper;
  }

  // --- Fetch live status from anchor_status, but present "NOT_FOUND" as "Queued" ---
  (async function loadStatus() {
    try {
      const r = await fetch(
        "/.netlify/functions/anchor_status?id=" + encodeURIComponent(proofId),
        { cache: "no-store" }
      );
      const data = await r.json().catch(() => ({}));

      const state = data.state || "NOT_FOUND";

      if (state === "ANCHORED") {
        // Green, anchored
        setStatus(
          "ok",
          "Anchored on Bitcoin",
          "Your proof has been anchored in a Bitcoin transaction. Confirmations will accumulate over time."
        );
        if (data.txid) {
          const mempoolUrl = "https://mempool.space/tx/" + encodeURIComponent(data.txid);
          txidValue.innerHTML =
            '<a class="value" href="' + mempoolUrl + '" target="_blank" rel="noopener">' +
            data.txid +
            "</a>";
        }
      } else if (state === "OTS_RECEIPT") {
        // Receipt exists, anchor pending
        setStatus(
          "warn",
          "Receipt created — awaiting anchor",
          "Your OpenTimestamps receipt is available and will be batched into a Bitcoin transaction shortly."
        );

        // Attempt to enable OTS download if available
        dlOts.disabled = false;
        dlOts.onclick = function () {
          window.location.href =
            "/.netlify/functions/download_receipt?id=" + encodeURIComponent(proofId);
        };
      } else {
        // NOT_FOUND or anything else → user-friendly pending
        setStatus(
          "neutral",
          "Queued for anchoring",
          "We do not yet see a receipt or Bitcoin anchor for this ID. If you just created this proof, allow time for batching and anchoring. You can always check back via the Verify page."
        );
      }
    } catch (e) {
      // On error, keep the default “queued” messaging
      console.error("success status load error:", e);
    }
  })();
})();
</script>

</body>
</html>